<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenamiento Interactivo - Frostware</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg-primary: #0a0e1a;
            --color-bg-secondary: #12172b;
            --color-bg-tertiary: #1a2038;
            --color-text-primary: #e4e8ef;
            --color-text-secondary: #9ca3af;
            --color-text-tertiary: #6b7280;
            --color-border-primary: #1e293b;
            --color-border-secondary: #2d3a52;
            --color-brand-primary: #22a7d0;
            --color-brand-secondary: #1e96bc;
            --color-brand-glow: rgba(34, 167, 208, 0.3);
            --color-success: #10b981;
            --color-error: #ef4444;
            --color-warning: #f59e0b;
            --color-accent-cyan: #06b6d4;
            --color-accent-blue: #3b82f6;
            --grid-pattern: repeating-linear-gradient(
                0deg,
                rgba(34, 167, 208, 0.03) 0px,
                transparent 1px,
                transparent 40px,
                rgba(34, 167, 208, 0.03) 41px
            ),
            repeating-linear-gradient(
                90deg,
                rgba(34, 167, 208, 0.03) 0px,
                transparent 1px,
                transparent 40px,
                rgba(34, 167, 208, 0.03) 41px
            );
        }

        html.light {
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f8fafc;
            --color-bg-tertiary: #f1f5f9;
            --color-text-primary: #0f172a;
            --color-text-secondary: #475569;
            --color-text-tertiary: #94a3b8;
            --color-border-primary: #e2e8f0;
            --color-border-secondary: #cbd5e1;
            --color-brand-glow: rgba(34, 167, 208, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: var(--grid-pattern);
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }

        .orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* Loading Animations */
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--color-border-primary);
            border-top: 4px solid var(--color-brand-primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            filter: drop-shadow(0 0 10px var(--color-brand-glow));
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Fade and Slide Animations */
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .slide-in-right {
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Staggered Animation Delays */
        .stagger-1 { animation-delay: 0.1s; opacity: 0; }
        .stagger-2 { animation-delay: 0.2s; opacity: 0; }
        .stagger-3 { animation-delay: 0.3s; opacity: 0; }
        .stagger-4 { animation-delay: 0.4s; opacity: 0; }

        /* Question Card */
        .question-card {
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-border-primary);
            border-radius: 20px;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-brand-primary), var(--color-accent-cyan), var(--color-brand-primary));
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }

        .question-card:hover {
            transform: translateY(-4px);
            border-color: var(--color-brand-primary);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--color-brand-glow);
        }

        /* Answer Options */
        .answer-option {
            background: var(--color-bg-tertiary);
            border: 2px solid var(--color-border-secondary);
            border-radius: 14px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .answer-option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--color-brand-primary);
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .answer-option:hover {
            border-color: var(--color-brand-primary);
            transform: translateX(8px);
            background: var(--color-bg-secondary);
        }

        .answer-option:hover::before {
            transform: scaleY(1);
        }

        .answer-option.selected {
            border-color: var(--color-brand-primary);
            background: rgba(34, 167, 208, 0.15);
            box-shadow: 0 0 20px var(--color-brand-glow);
        }

        .answer-option.selected::before {
            transform: scaleY(1);
        }

        /* Exam Mode - Neutral Selection */
        .exam-mode .answer-option.selected {
            border-color: var(--color-accent-blue);
            background: rgba(59, 130, 246, 0.15);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .exam-mode .answer-option.selected::before {
            background: var(--color-accent-blue);
        }

        /* Practice Mode - Correct/Incorrect Feedback */
        .answer-option.correct {
            border-color: var(--color-success);
            background: rgba(16, 185, 129, 0.15);
            animation: correctPulse 0.6s ease-out;
        }

        .answer-option.correct::before {
            background: var(--color-success);
            transform: scaleY(1);
        }

        .answer-option.incorrect {
            border-color: var(--color-error);
            background: rgba(239, 68, 68, 0.15);
            animation: incorrectShake 0.5s ease-out;
        }

        .answer-option.incorrect::before {
            background: var(--color-error);
            transform: scaleY(1);
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* Stats Dashboard */
        .stats-card {
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-border-primary);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stats-card:hover {
            border-color: var(--color-brand-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'Orbitron', sans-serif;
            line-height: 1;
            background: linear-gradient(135deg, var(--color-brand-primary), var(--color-accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value.success {
            background: linear-gradient(135deg, var(--color-success), #34d399);
        }

        .stat-value.error {
            background: linear-gradient(135deg, var(--color-error), #f87171);
        }

        .stat-value.warning {
            background: linear-gradient(135deg, var(--color-warning), #fbbf24);
        }

        /* Progress Bar */
        .progress-bar {
            height: 10px;
            background: var(--color-bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-brand-primary), var(--color-accent-cyan));
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 0 10px var(--color-brand-glow);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShine 2s ease-in-out infinite;
        }

        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        /* Timer */
        .timer-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-brand-primary);
            text-shadow: 0 0 20px var(--color-brand-glow);
            letter-spacing: 0.1em;
        }

        .timer-display.warning {
            color: var(--color-warning);
            animation: timerPulse 1s ease-in-out infinite;
        }

        .timer-display.critical {
            color: var(--color-error);
            animation: timerPulse 0.5s ease-in-out infinite;
        }

        @keyframes timerPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        /* Bookmark Button */
        .bookmark-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--color-bg-tertiary);
            border: 2px solid var(--color-border-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .bookmark-btn:hover {
            border-color: var(--color-warning);
            transform: scale(1.1) rotate(5deg);
            background: rgba(245, 158, 11, 0.1);
        }

        .bookmark-btn.bookmarked {
            border-color: var(--color-warning);
            background: rgba(245, 158, 11, 0.2);
            animation: bookmarkPop 0.4s ease-out;
        }

        @keyframes bookmarkPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1); }
        }

        /* Image Popup Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            opacity: 0;
            animation: modalFadeIn 0.3s ease-out forwards;
        }

        @keyframes modalFadeIn {
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-brand-primary);
            border-radius: 20px;
            max-width: 900px;
            max-height: 90vh;
            overflow: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--color-brand-glow);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(50px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--color-error);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .modal-close:hover {
            background: var(--color-error);
            transform: rotate(90deg) scale(1.1);
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--color-brand-primary), var(--color-brand-secondary));
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--color-brand-glow);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .btn-primary:hover::before {
            transform: translateX(100%);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px var(--color-brand-glow);
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            border: 2px solid var(--color-border-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-secondary:hover {
            border-color: var(--color-brand-primary);
            background: var(--color-bg-secondary);
            transform: translateY(-2px);
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Question Navigator */
        .question-nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
            gap: 0.5rem;
        }

        .question-nav-item {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: var(--color-bg-tertiary);
            border: 2px solid var(--color-border-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .question-nav-item:hover {
            transform: scale(1.1);
            border-color: var(--color-brand-primary);
        }

        .question-nav-item.current {
            border-color: var(--color-brand-primary);
            background: rgba(34, 167, 208, 0.2);
            box-shadow: 0 0 15px var(--color-brand-glow);
        }

        .question-nav-item.answered {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--color-success);
        }

        .question-nav-item.bookmarked::after {
            content: '★';
            position: absolute;
            top: -4px;
            right: -4px;
            font-size: 0.75rem;
            color: var(--color-warning);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 380px;
            background: var(--color-bg-secondary);
            border-left: 2px solid var(--color-border-primary);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            overflow-y: auto;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        /* Mode Badge */
        .mode-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .mode-badge.practice {
            background: rgba(16, 185, 129, 0.2);
            color: var(--color-success);
            border: 2px solid var(--color-success);
        }

        .mode-badge.exam {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-error);
            border: 2px solid var(--color-error);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-border-secondary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-brand-primary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .question-card {
                padding: 1.5rem;
            }

            .stats-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 2rem;
            }

            .timer-display {
                font-size: 1.5rem;
            }
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--color-success);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .save-indicator.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="flex flex-col items-center justify-center min-h-screen relative z-10">
        <div class="loading-spinner"></div>
        <p class="mt-6 text-lg orbitron" style="color: var(--color-text-secondary);">VERIFICANDO ACCESO...</p>
        <div class="mt-4 flex gap-2">
            <div class="w-2 h-2 rounded-full bg-current pulse-glow" style="color: var(--color-brand-primary);"></div>
            <div class="w-2 h-2 rounded-full bg-current pulse-glow" style="color: var(--color-brand-primary); animation-delay: 0.2s;"></div>
            <div class="w-2 h-2 rounded-full bg-current pulse-glow" style="color: var(--color-brand-primary); animation-delay: 0.4s;"></div>
        </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="access-denied-screen" class="hidden flex flex-col items-center justify-center min-h-screen px-4 relative z-10">
        <div class="max-w-md w-full question-card fade-in text-center">
            <div class="w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center" style="background: rgba(239, 68, 68, 0.2); border: 3px solid var(--color-error);">
                <svg class="w-12 h-12" style="color: var(--color-error);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold orbitron mb-4" style="color: var(--color-text-primary);">ACCESO DENEGADO</h2>
            <p class="mb-8" style="color: var(--color-text-secondary);" id="access-denied-message">
                No tienes acceso a este producto. Por favor, adquiérelo primero.
            </p>
            <div class="space-y-3">
                <button onclick="goToProducts()" class="btn-primary w-full">VER PRODUCTOS</button>
                <button onclick="goToLogin()" class="btn-secondary w-full">INICIAR SESIÓN</button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="hidden">
        <!-- Header -->
        <header style="background: var(--color-bg-secondary); border-bottom: 2px solid var(--color-border-primary);">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <button onclick="exitApp()" class="btn-secondary p-3" style="padding: 0.75rem;">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                        </button>
                        <div>
                            <h1 class="text-xl font-bold orbitron" id="product-title" style="color: var(--color-text-primary);">ENTRENAMIENTO INTERACTIVO</h1>
                            <div class="flex items-center gap-3 mt-1">
                                <span class="mode-badge practice" id="mode-badge">
                                    <span id="mode-icon">●</span>
                                    <span id="mode-text">MODO PRÁCTICA</span>
                                </span>
                                <span class="text-sm" style="color: var(--color-text-secondary);" id="session-info">50 Preguntas</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <!-- Timer (Exam Mode Only) -->
                        <div id="timer-container" class="hidden">
                            <div class="text-sm" style="color: var(--color-text-secondary);">TIEMPO RESTANTE</div>
                            <div class="timer-display" id="timer-display">60:00</div>
                        </div>

                        <!-- Stats Toggle -->
                        <button onclick="toggleSidebar()" class="btn-secondary p-3 relative" style="padding: 0.75rem;">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <span class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full pulse-glow"></span>
                        </button>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold orbitron" style="color: var(--color-text-secondary);">PROGRESO</span>
                        <span class="text-sm font-bold orbitron" id="progress-text" style="color: var(--color-brand-primary);">0 / 50</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-8 relative z-10" style="margin-right: 0; max-width: calc(100% - 0px);" id="main-content">
            <div class="max-w-4xl mx-auto" id="question-container">
                <!-- Questions load here -->
                <div class="text-center py-12">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-6 text-lg orbitron" style="color: var(--color-text-secondary);">CARGANDO PREGUNTAS...</p>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="max-w-4xl mx-auto mt-8 flex justify-between gap-4 flex-wrap">
                <button id="prev-btn" onclick="previousQuestion()" class="btn-secondary flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    ANTERIOR
                </button>

                <div class="flex gap-4">
                    <button id="save-session-btn" onclick="saveSession()" class="btn-secondary">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                        </svg>
                        GUARDAR
                    </button>

                    <button id="next-btn" onclick="nextQuestion()" class="btn-primary flex items-center gap-2">
                        SIGUIENTE
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>

                <button id="finish-btn" onclick="finishSession()" class="btn-primary hidden">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    FINALIZAR SESIÓN
                </button>
            </div>
        </main>

        <!-- Stats Sidebar -->
        <aside class="sidebar" id="stats-sidebar">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold orbitron" style="color: var(--color-text-primary);">ESTADÍSTICAS</h2>
                    <button onclick="toggleSidebar()" class="btn-secondary p-2" style="padding: 0.5rem;">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="stats-card fade-in-up stagger-1">
                        <div class="text-sm mb-2 orbitron" style="color: var(--color-text-secondary);">CONTESTADAS</div>
                        <div class="stat-value" id="stat-answered">0</div>
                    </div>

                    <div class="stats-card fade-in-up stagger-2">
                        <div class="text-sm mb-2 orbitron" style="color: var(--color-text-secondary);">SIN CONTESTAR</div>
                        <div class="stat-value warning" id="stat-unanswered">50</div>
                    </div>

                    <div class="stats-card fade-in-up stagger-3" id="stat-correct-card">
                        <div class="text-sm mb-2 orbitron" style="color: var(--color-text-secondary);">CORRECTAS</div>
                        <div class="stat-value success" id="stat-correct">0</div>
                    </div>

                    <div class="stats-card fade-in-up stagger-4" id="stat-incorrect-card">
                        <div class="text-sm mb-2 orbitron" style="color: var(--color-text-secondary);">INCORRECTAS</div>
                        <div class="stat-value error" id="stat-incorrect">0</div>
                    </div>
                </div>

                <!-- Score (Practice Mode Only) -->
                <div id="score-card" class="stats-card mb-6 text-center">
                    <div class="text-sm mb-2 orbitron" style="color: var(--color-text-secondary);">PUNTUACIÓN ACTUAL</div>
                    <div class="stat-value" id="score-text" style="font-size: 3.5rem;">0%</div>
                </div>

                <!-- Bookmarked Questions -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold orbitron mb-3 flex items-center gap-2" style="color: var(--color-text-primary);">
                        <svg class="w-5 h-5" style="color: var(--color-warning);" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        MARCADAS (<span id="bookmark-count">0</span>)
                    </h3>
                    <div id="bookmarked-list" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-sm" style="color: var(--color-text-tertiary);">No hay preguntas marcadas</p>
                    </div>
                </div>

                <!-- Question Navigator -->
                <div>
                    <h3 class="text-lg font-bold orbitron mb-3" style="color: var(--color-text-primary);">NAVEGACIÓN</h3>
                    <div class="question-nav-grid" id="question-navigator">
                        <!-- Question nav items load here -->
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="save-indicator">
        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Progreso guardado
    </div>

    <!-- Image Modal (Template) -->
    <div id="image-modal" class="modal-overlay hidden" onclick="closeImageModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeImageModal()">
                <svg class="w-6 h-6" style="color: var(--color-error);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <img id="modal-image" src="" alt="Question Image" class="w-full h-auto rounded-lg" style="max-height: 80vh; object-fit: contain;">
            <div class="p-6">
                <p id="modal-caption" class="text-center" style="color: var(--color-text-secondary);"></p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAWu3dkO1hPWxFajvpPmFvxrhK-YVcqMR8",
            authDomain: "frostware-website.firebaseapp.com",
            projectId: "frostware-website",
            storageBucket: "frostware-website.firebasestorage.app",
            messagingSenderId: "877959550313",
            appId: "1:877959550313:web:1fde3d91d76df2e1e50a99",
            measurementId: "G-SNPYXQXJCZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        window.currentUser = null;
        window.currentProduct = null;
        window.questions = [];
        window.currentQuestionIndex = 0;
        window.userAnswers = [];
        window.bookmarkedQuestions = new Set();
        window.sessionStartTime = Date.now();
        window.sessionMode = 'practice'; // 'practice' or 'exam'
        window.examDuration = 3600; // seconds (60 minutes default)
        window.examTimeRemaining = 3600;
        window.timerInterval = null;
        window.sessionId = null;

        // Get product ID and mode from URL
        function getURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                productId: urlParams.get('productId') || 'north-atlantic-ops',
                mode: urlParams.get('mode') || 'practice',
                duration: parseInt(urlParams.get('duration')) || 3600,
                sessionId: urlParams.get('sessionId') || null
            };
        }

        // Verify user access to product
        async function verifyAccess(userId, productId) {
            try {
                const userProductRef = doc(db, 'users', userId, 'products', productId);
                const userProductDoc = await getDoc(userProductRef);

                if (userProductDoc.exists()) {
                    return { hasAccess: true, message: 'Access granted' };
                }

                return { hasAccess: false, message: 'Este producto no está en tu biblioteca. Por favor adquiérelo primero.' };
            } catch (error) {
                console.error('Error verificando acceso:', error);
                return { hasAccess: false, message: 'Error verificando el acceso. Por favor intenta de nuevo.' };
            }
        }

        // Load product information
        async function loadProduct(productId) {
            try {
                const productRef = doc(db, 'products', productId);
                const productDoc = await getDoc(productRef);

                if (productDoc.exists()) {
                    return { id: productDoc.id, ...productDoc.data() };
                }
                return null;
            } catch (error) {
                console.error('Error cargando producto:', error);
                return null;
            }
        }

        // Load questions
        async function loadQuestions(productId) {
            // TODO: Replace with actual Firestore query
            // For now, return sample questions with image support
            return [
                {
                    id: 'q1',
                    topic: 'Communications',
                    question: '¿Cuál es la frecuencia principal de HF para comunicaciones NAT?',
                    image: null, // Optional: URL to image
                    options: [
                        '123.45 MHz',
                        '8.891 MHz',
                        '121.5 MHz',
                        '5.680 MHz'
                    ],
                    correctAnswer: 1,
                    explanation: 'La frecuencia 8.891 MHz es una de las principales frecuencias HF utilizadas para comunicaciones en el Atlántico Norte.'
                },
                {
                    id: 'q2',
                    topic: 'Navigation',
                    question: '¿Qué significa el término "SLOP" en navegación NAT?',
                    image: null,
                    options: [
                        'Strategic Lateral Offset Procedure',
                        'Standard Landing Operation Protocol',
                        'Secondary Line Of Position',
                        'Safe Level Of Performance'
                    ],
                    correctAnswer: 0,
                    explanation: 'SLOP (Strategic Lateral Offset Procedure) es un procedimiento que permite desviaciones laterales de hasta 2 NM para evitar turbulencia de estela.'
                },
                // Add more questions...
            ];
        }

        // Load saved session
        async function loadSavedSession(userId, productId, sessionId) {
            try {
                const sessionRef = doc(db, 'users', userId, 'sessions', sessionId);
                const sessionDoc = await getDoc(sessionRef);

                if (sessionDoc.exists()) {
                    return sessionDoc.data();
                }
                return null;
            } catch (error) {
                console.error('Error loading session:', error);
                return null;
            }
        }

        // Save session to Firestore
        window.saveSession = async function() {
            if (!window.currentUser || !window.currentProduct) return;

            try {
                const sessionData = {
                    productId: window.currentProduct.id,
                    mode: window.sessionMode,
                    currentQuestionIndex: window.currentQuestionIndex,
                    userAnswers: window.userAnswers,
                    bookmarkedQuestions: Array.from(window.bookmarkedQuestions),
                    timeRemaining: window.sessionMode === 'exam' ? window.examTimeRemaining : null,
                    totalQuestions: window.questions.length,
                    lastUpdated: serverTimestamp(),
                    completed: false
                };

                const sessionRef = doc(db, 'users', window.currentUser.uid, 'sessions', window.sessionId || `session_${Date.now()}`);

                if (!window.sessionId) {
                    window.sessionId = `session_${Date.now()}`;
                }

                await setDoc(sessionRef, sessionData, { merge: true });

                // Show save indicator
                showSaveIndicator();

                console.log('Session saved successfully');
            } catch (error) {
                console.error('Error saving session:', error);
                alert('Error al guardar la sesión');
            }
        };

        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Initialize app
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                showAccessDenied('Debes iniciar sesión para acceder a esta aplicación.');
                return;
            }

            window.currentUser = user;
            const params = getURLParams();

            window.sessionMode = params.mode;
            window.examDuration = params.duration;
            window.examTimeRemaining = params.duration;
            window.sessionId = params.sessionId;

            // Verify access
            const accessCheck = await verifyAccess(user.uid, params.productId);

            if (!accessCheck.hasAccess) {
                showAccessDenied(accessCheck.message);
                return;
            }

            // Load product and questions
            window.currentProduct = await loadProduct(params.productId);
            window.questions = await loadQuestions(params.productId);

            if (!window.currentProduct || window.questions.length === 0) {
                showAccessDenied('No se pudieron cargar las preguntas. Por favor intenta de nuevo.');
                return;
            }

            // Load saved session if resuming
            if (window.sessionId) {
                const savedSession = await loadSavedSession(user.uid, params.productId, window.sessionId);
                if (savedSession) {
                    window.currentQuestionIndex = savedSession.currentQuestionIndex || 0;
                    window.userAnswers = savedSession.userAnswers || [];
                    window.bookmarkedQuestions = new Set(savedSession.bookmarkedQuestions || []);
                    if (savedSession.timeRemaining) {
                        window.examTimeRemaining = savedSession.timeRemaining;
                    }
                }
            }

            // Show app
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');

            // Initialize UI
            updateProductTitle();
            updateModeUI();
            initializeQuestionNavigator();
            loadQuestion(window.currentQuestionIndex);

            // Start timer for exam mode
            if (window.sessionMode === 'exam') {
                startExamTimer();
            }

            // Auto-save every 30 seconds
            setInterval(() => {
                if (window.currentUser) {
                    saveSession();
                }
            }, 30000);
        });

        // Show access denied screen
        function showAccessDenied(message) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('access-denied-screen').classList.remove('hidden');
            document.getElementById('access-denied-message').textContent = message;
        }

        // Update product title
        function updateProductTitle() {
            const titleElement = document.getElementById('product-title');
            if (window.currentProduct && window.currentProduct.name) {
                const lang = 'es';
                titleElement.textContent = typeof window.currentProduct.name === 'object'
                    ? window.currentProduct.name[lang]
                    : window.currentProduct.name;
            }
        }

        // Update mode UI
        function updateModeUI() {
            const modeBadge = document.getElementById('mode-badge');
            const modeText = document.getElementById('mode-text');
            const timerContainer = document.getElementById('timer-container');
            const scoreCard = document.getElementById('score-card');
            const statCorrectCard = document.getElementById('stat-correct-card');
            const statIncorrectCard = document.getElementById('stat-incorrect-card');
            const appScreen = document.getElementById('app-screen');

            if (window.sessionMode === 'exam') {
                modeBadge.className = 'mode-badge exam';
                modeText.textContent = 'MODO EXAMEN';
                timerContainer.classList.remove('hidden');
                scoreCard.style.display = 'none';
                statCorrectCard.style.display = 'none';
                statIncorrectCard.style.display = 'none';
                appScreen.classList.add('exam-mode');
            } else {
                modeBadge.className = 'mode-badge practice';
                modeText.textContent = 'MODO PRÁCTICA';
                timerContainer.classList.add('hidden');
                scoreCard.style.display = 'block';
                statCorrectCard.style.display = 'block';
                statIncorrectCard.style.display = 'block';
                appScreen.classList.remove('exam-mode');
            }
        }

        // Start exam timer
        function startExamTimer() {
            updateTimerDisplay();

            window.timerInterval = setInterval(() => {
                window.examTimeRemaining--;
                updateTimerDisplay();

                if (window.examTimeRemaining <= 0) {
                    clearInterval(window.timerInterval);
                    finishSession();
                }
            }, 1000);
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(window.examTimeRemaining / 60);
            const seconds = window.examTimeRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const timerElement = document.getElementById('timer-display');
            timerElement.textContent = display;

            // Add warning/critical classes
            timerElement.className = 'timer-display';
            if (window.examTimeRemaining <= 300) { // 5 minutes
                timerElement.classList.add('critical');
            } else if (window.examTimeRemaining <= 600) { // 10 minutes
                timerElement.classList.add('warning');
            }
        }

        // Initialize question navigator
        function initializeQuestionNavigator() {
            const navigator = document.getElementById('question-navigator');
            navigator.innerHTML = window.questions.map((q, i) => {
                const isAnswered = window.userAnswers[i] !== undefined;
                const isBookmarked = window.bookmarkedQuestions.has(i);
                const isCurrent = i === window.currentQuestionIndex;

                return `
                    <div
                        class="question-nav-item ${isCurrent ? 'current' : ''} ${isAnswered ? 'answered' : ''} ${isBookmarked ? 'bookmarked' : ''}"
                        onclick="jumpToQuestion(${i})"
                    >
                        ${i + 1}
                    </div>
                `;
            }).join('');
        }

        // Jump to specific question
        window.jumpToQuestion = function(index) {
            window.currentQuestionIndex = index;
            loadQuestion(index);
        };

        // Load question
        function loadQuestion(index) {
            const question = window.questions[index];
            if (!question) return;

            const container = document.getElementById('question-container');
            const userAnswer = window.userAnswers[index];
            const isBookmarked = window.bookmarkedQuestions.has(index);
            const isPracticeMode = window.sessionMode === 'practice';

            let optionsHTML = question.options.map((option, i) => {
                let className = 'answer-option';

                // In practice mode, show correct/incorrect after answering
                if (isPracticeMode && userAnswer !== undefined) {
                    if (i === question.correctAnswer) {
                        className += ' correct';
                    } else if (i === userAnswer && i !== question.correctAnswer) {
                        className += ' incorrect';
                    }
                }
                // In both modes, show selected state
                else if (i === userAnswer) {
                    className += ' selected';
                }

                return `
                    <div class="${className} fade-in-up stagger-${i + 1}" onclick="selectAnswer(${i})" data-option="${i}">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold orbitron" style="background: var(--color-brand-primary); color: white;">
                                ${String.fromCharCode(65 + i)}
                            </div>
                            <span style="color: var(--color-text-primary); flex: 1;">${option}</span>
                            ${isPracticeMode && userAnswer !== undefined && i === question.correctAnswer ? `
                                <svg class="w-6 h-6" style="color: var(--color-success);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            ` : ''}
                            ${isPracticeMode && userAnswer !== undefined && i === userAnswer && i !== question.correctAnswer ? `
                                <svg class="w-6 h-6" style="color: var(--color-error);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="question-card fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <span class="text-sm font-semibold px-4 py-2 rounded-full orbitron" style="background: rgba(34, 167, 208, 0.2); color: var(--color-brand-primary); border: 2px solid var(--color-brand-primary);">
                            ${question.topic.toUpperCase()}
                        </span>
                        <div class="flex items-center gap-4">
                            <span class="text-sm orbitron" style="color: var(--color-text-secondary);">
                                PREGUNTA ${index + 1} / ${window.questions.length}
                            </span>
                            <button
                                class="bookmark-btn ${isBookmarked ? 'bookmarked' : ''}"
                                onclick="toggleBookmark(${index})"
                                title="Marcar pregunta"
                            >
                                <svg class="w-6 h-6" style="color: ${isBookmarked ? 'var(--color-warning)' : 'var(--color-text-secondary)'};" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <h2 class="text-2xl font-bold mb-6 orbitron" style="color: var(--color-text-primary);">
                        ${question.question}
                    </h2>

                    ${question.image ? `
                        <div class="mb-6 relative group cursor-pointer" onclick="openImageModal('${question.image}', '${question.question}')">
                            <img src="${question.image}" alt="Question diagram" class="w-full rounded-lg" style="max-height: 300px; object-fit: contain; border: 2px solid var(--color-border-primary);">
                            <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-lg">
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                                </svg>
                            </div>
                        </div>
                    ` : ''}

                    <div class="space-y-3">
                        ${optionsHTML}
                    </div>

                    ${isPracticeMode && userAnswer !== undefined ? `
                        <div class="mt-6 p-5 rounded-xl fade-in" style="background: ${userAnswer === question.correctAnswer ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)'}; border: 2px solid ${userAnswer === question.correctAnswer ? 'var(--color-success)' : 'var(--color-error)'};">
                            <p class="font-bold mb-3 text-lg flex items-center gap-2" style="color: var(--color-text-primary);">
                                ${userAnswer === question.correctAnswer ? `
                                    <svg class="w-6 h-6" style="color: var(--color-success);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    ¡CORRECTO!
                                ` : `
                                    <svg class="w-6 h-6" style="color: var(--color-error);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    INCORRECTO
                                `}
                            </p>
                            <p style="color: var(--color-text-secondary);">${question.explanation}</p>
                        </div>
                    ` : ''}
                </div>
            `;

            updateProgress();
            updateNavigationButtons();
            initializeQuestionNavigator();
            updateBookmarkedList();
        }

        // Select answer
        window.selectAnswer = function(optionIndex) {
            // In exam mode or practice mode, allow changing answer
            window.userAnswers[window.currentQuestionIndex] = optionIndex;
            loadQuestion(window.currentQuestionIndex);
        };

        // Toggle bookmark
        window.toggleBookmark = function(index) {
            if (window.bookmarkedQuestions.has(index)) {
                window.bookmarkedQuestions.delete(index);
            } else {
                window.bookmarkedQuestions.add(index);
            }
            loadQuestion(window.currentQuestionIndex);
            updateBookmarkedList();
        };

        // Update bookmarked list
        function updateBookmarkedList() {
            const list = document.getElementById('bookmarked-list');
            const count = document.getElementById('bookmark-count');

            count.textContent = window.bookmarkedQuestions.size;

            if (window.bookmarkedQuestions.size === 0) {
                list.innerHTML = '<p class="text-sm" style="color: var(--color-text-tertiary);">No hay preguntas marcadas</p>';
                return;
            }

            list.innerHTML = Array.from(window.bookmarkedQuestions)
                .sort((a, b) => a - b)
                .map(index => `
                    <div
                        class="p-3 rounded-lg cursor-pointer transition-all"
                        style="background: var(--color-bg-tertiary); border: 2px solid var(--color-border-secondary);"
                        onmouseover="this.style.borderColor='var(--color-brand-primary)'"
                        onmouseout="this.style.borderColor='var(--color-border-secondary)'"
                        onclick="jumpToQuestion(${index})"
                    >
                        <div class="flex items-center justify-between">
                            <span class="font-semibold orbitron" style="color: var(--color-text-primary);">Pregunta ${index + 1}</span>
                            <span class="text-xs" style="color: var(--color-text-secondary);">${window.questions[index].topic}</span>
                        </div>
                    </div>
                `).join('');
        }

        // Next question
        window.nextQuestion = function() {
            if (window.currentQuestionIndex < window.questions.length - 1) {
                window.currentQuestionIndex++;
                loadQuestion(window.currentQuestionIndex);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // Previous question
        window.previousQuestion = function() {
            if (window.currentQuestionIndex > 0) {
                window.currentQuestionIndex--;
                loadQuestion(window.currentQuestionIndex);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // Update progress
        function updateProgress() {
            const answeredCount = window.userAnswers.filter(a => a !== undefined).length;
            const unansweredCount = window.questions.length - answeredCount;
            const progress = (answeredCount / window.questions.length) * 100;

            document.getElementById('progress-text').textContent = `${answeredCount} / ${window.questions.length}`;
            document.getElementById('progress-fill').style.width = `${progress}%`;

            // Update stats
            document.getElementById('stat-answered').textContent = answeredCount;
            document.getElementById('stat-unanswered').textContent = unansweredCount;

            // Calculate score (practice mode only)
            if (window.sessionMode === 'practice') {
                const correctCount = window.userAnswers.filter((answer, index) =>
                    answer === window.questions[index].correctAnswer
                ).length;
                const incorrectCount = answeredCount - correctCount;
                const score = answeredCount > 0 ? Math.round((correctCount / answeredCount) * 100) : 0;

                document.getElementById('stat-correct').textContent = correctCount;
                document.getElementById('stat-incorrect').textContent = incorrectCount;
                document.getElementById('score-text').textContent = `${score}%`;
            }
        }

        // Update navigation buttons
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const finishBtn = document.getElementById('finish-btn');

            prevBtn.disabled = window.currentQuestionIndex === 0;

            const allAnswered = window.userAnswers.filter(a => a !== undefined).length === window.questions.length;

            if (allAnswered) {
                nextBtn.classList.add('hidden');
                finishBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                finishBtn.classList.add('hidden');
            }
        }

        // Toggle sidebar
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('stats-sidebar');
            sidebar.classList.toggle('open');
        };

        // Open image modal
        window.openImageModal = function(imageSrc, caption) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const modalCaption = document.getElementById('modal-caption');

            modalImage.src = imageSrc;
            modalCaption.textContent = caption;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        // Close image modal
        window.closeImageModal = function(event) {
            if (!event || event.target.id === 'image-modal') {
                const modal = document.getElementById('image-modal');
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        };

        // Finish session
        window.finishSession = async function() {
            if (window.timerInterval) {
                clearInterval(window.timerInterval);
            }

            const timeSpent = Math.floor((Date.now() - window.sessionStartTime) / 1000);
            const correctCount = window.userAnswers.filter((answer, index) =>
                answer === window.questions[index].correctAnswer
            ).length;

            const results = {
                productId: window.currentProduct.id,
                mode: window.sessionMode,
                totalQuestions: window.questions.length,
                correctAnswers: correctCount,
                incorrectAnswers: window.questions.length - correctCount,
                score: Math.round((correctCount / window.questions.length) * 100),
                timeSpent: timeSpent,
                completed: true,
                completedAt: serverTimestamp(),
                answers: window.questions.map((q, i) => ({
                    questionId: q.id,
                    topic: q.topic,
                    userAnswer: window.userAnswers[i],
                    correctAnswer: q.correctAnswer,
                    isCorrect: window.userAnswers[i] === q.correctAnswer
                }))
            };

            try {
                // Save final session
                const sessionRef = doc(db, 'users', window.currentUser.uid, 'sessions', window.sessionId || `session_${Date.now()}`);
                await setDoc(sessionRef, results, { merge: true });

                // Show results
                const message = window.sessionMode === 'exam'
                    ? `¡EXAMEN COMPLETADO!\n\nTiempo: ${Math.floor(timeSpent / 60)}:${(timeSpent % 60).toString().padStart(2, '0')}\nRespuestas correctas: ${correctCount}/${window.questions.length}\nPuntuación: ${results.score}%`
                    : `¡SESIÓN COMPLETADA!\n\nTiempo: ${Math.floor(timeSpent / 60)}:${(timeSpent % 60).toString().padStart(2, '0')}\nCorrectas: ${correctCount}/${window.questions.length}\nIncorrectas: ${results.incorrectAnswers}\nPuntuación: ${results.score}%`;

                alert(message);
                window.location.href = '/#/products';
            } catch (error) {
                console.error('Error saving session:', error);
                alert('Error al guardar los resultados');
            }
        };

        // Navigation functions
        window.goToProducts = function() {
            window.location.href = '/#/products';
        };

        window.goToLogin = function() {
            window.location.href = '/#/auth/login';
        };

        window.exitApp = function() {
            const message = window.userAnswers.filter(a => a !== undefined).length > 0
                ? '¿Estás seguro de que quieres salir? Tu progreso ha sido guardado y podrás continuar después.'
                : '¿Estás seguro de que quieres salir?';

            if (confirm(message)) {
                if (window.timerInterval) {
                    clearInterval(window.timerInterval);
                }
                saveSession();
                window.location.href = '/#/products';
            }
        };

        // Handle page unload
        window.addEventListener('beforeunload', (e) => {
            if (window.userAnswers.filter(a => a !== undefined).length > 0) {
                saveSession();
            }
        });
    </script>
</body>
</html>
